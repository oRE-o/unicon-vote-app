name: CI/CD with Docker Compose

on:
  push:
    branches: ["main"]

env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKERHUB_USERNAME }}/unicon-vote-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKERHUB_USERNAME }}/unicon-vote-frontend

jobs:
  # --- ë°±ì—”ë“œ ë¹Œë“œ ë° í‘¸ì‹œ ì¡ (ë³€ê²½ ì—†ìŒ) ---
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v4
        with:
          context: ./unicon-vote-backend
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest

  # --- í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° í‘¸ì‹œ ì¡ (API_BASE_URL ì „ë‹¬í•˜ë„ë¡ ìˆ˜ì •) ---
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./unicon-vote-frontend
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          # --- ğŸ‘‡ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œ API_BASE_URL í™˜ê²½ë³€ìˆ˜ ì „ë‹¬ ---
          # ë°°í¬ë  ì„œë²„ì˜ IPë¥¼ VITE_API_BASE_URLë¡œ ì£¼ì…
          build-args: |
            VITE_API_BASE_URL=http://${{ secrets.SERVER_HOST }}:5001
            # ğŸ’¡ ì¤‘ìš”: ì„œë²„ IPë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. EC2ì— ë„ë©”ì¸ì„ ì—°ê²°í–ˆë‹¤ë©´ ë„ë©”ì¸ìœ¼ë¡œ.

  # --- ì„œë²„ì— ë°°í¬í•˜ëŠ” ì¡ (CD) - Docker Compose ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ ---
  deploy:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1. git clone ë°›ì•„ë‘” í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
            cd unicon-vote-app

            # 2. main ë¸Œëœì¹˜ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­(docker-compose.yml ë“±)ì„ ë°›ì•„ì˜µë‹ˆë‹¤.
            git pull origin main

            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" > .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "ADMIN_UUID=${{ secrets.ADMIN_UUID }}" >> .env
            echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
            echo "MONGO_ROOT_USER=${{ secrets.MONGO_ROOT_USER }}" >> .env
            echo "MONGO_ROOT_PASSWORD=${{ secrets.MONGO_ROOT_PASSWORD }}" >> .env
            echo "MONGO_URI=${{ secrets.MONGO_URI }}" >> .env
            echo "CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}" >> .env 

            # 3. Docker Hubì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            # 4. docker-composeë¡œ ìµœì‹  ì´ë¯¸ì§€ë¥¼ pullí•˜ê³  ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘/ì¬ì‹œì‘í•©ë‹ˆë‹¤.
            docker-compose pull
            docker-compose up -d

            # 5. ë¶ˆí•„ìš”í•˜ê²Œ ìŒ“ì¸ ì˜›ë‚  Docker ì´ë¯¸ì§€ë“¤ì„ ì •ë¦¬í•©ë‹ˆë‹¤ (ì„ íƒì‚¬í•­ì´ì§€ë§Œ ì¶”ì²œ).
            docker image prune -f

            echo "Deployment completed successfully!"
