name: CI/CD with Docker Compose

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKERHUB_USERNAME }}/unicon-vote-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKERHUB_USERNAME }}/unicon-vote-frontend

jobs:
  # --- ë°±ì—”ë“œ ë¹Œë“œ ë° í‘¸ì‹œ ì¡ (ë³€ê²½ ì—†ìŒ) ---
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v4
        with:
          context: ./unicon-vote-backend
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest

  # --- í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° í‘¸ì‹œ ì¡ (API_BASE_URL ì „ë‹¬í•˜ë„ë¡ ìˆ˜ì •) ---
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./unicon-vote-frontend
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          # --- ğŸ‘‡ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œ API_BASE_URL í™˜ê²½ë³€ìˆ˜ ì „ë‹¬ ---
          # ë°°í¬ë  ì„œë²„ì˜ IPë¥¼ VITE_API_BASE_URLë¡œ ì£¼ì…
          build-args: |
            VITE_API_BASE_URL=http://${{ secrets.SERVER_HOST }}:5001
            # ğŸ’¡ ì¤‘ìš”: ì„œë²„ IPë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. EC2ì— ë„ë©”ì¸ì„ ì—°ê²°í–ˆë‹¤ë©´ ë„ë©”ì¸ìœ¼ë¡œ.

  # --- ì„œë²„ì— ë°°í¬í•˜ëŠ” ì¡ (CD) - Docker Compose ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ ---
  deploy:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3 # docker-compose.yml íŒŒì¼ ê°€ì ¸ì˜¤ê¸°

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # ì„œë²„ì— ì ‘ì†í•˜ì—¬ Docker Hub ë¡œê·¸ì¸
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            # GitHub ì €ì¥ì†Œì—ì„œ docker-compose.yml íŒŒì¼ì„ ì„œë²„ë¡œ ë³µì‚¬
            # (actions/checkoutìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ì— docker-compose.ymlì´ ì¡´ì¬)
            # cp /home/runner/work/<repo_name>/<repo_name>/docker-compose.yml /tmp/docker-compose.yml
            # ì´ ì›Œí¬í”Œë¡œìš°ëŠ” .github/workflows/main.ymlì´ ìœ„ì¹˜í•œ ë ˆí¬ì˜ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ,
            # docker-compose.ymlì´ ë£¨íŠ¸ì— ìˆë‹¤ë©´ ê²½ë¡œê°€ '.'ì´ ë©ë‹ˆë‹¤.
            
            # Docker Compose ì‹¤í–‰ ì „ í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            # Docker ComposeëŠ” .env íŒŒì¼ì´ ì—†ìœ¼ë©´ ì‰˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            export MONGO_URI="${{ secrets.MONGO_URI }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export ADMIN_UUID="${{ secrets.ADMIN_UUID }}"
            export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
            
            # Docker Composeë¥¼ ì´ìš©í•´ ëª¨ë“  ì„œë¹„ìŠ¤(backend, frontend, mongo) ì‹¤í–‰
            # -f: docker-compose íŒŒì¼ ì§€ì •
            # pull: ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            # up -d: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë¹„ìŠ¤ ì‹œì‘ (ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ ì¬ì‹œì‘/ì—…ë°ì´íŠ¸)
            # --build: í•„ìš”ì‹œ ë¡œì»¬ì—ì„œ ì´ë¯¸ì§€ ë‹¤ì‹œ ë¹Œë“œ (ì—¬ê¸°ì„œëŠ” Docker Hubì—ì„œ í’€ ë°›ìœ¼ë‹ˆ í•„ìš” ì—†ìŒ)
            docker-compose -f docker-compose.yml pull
            docker-compose -f docker-compose.yml up -d
            
            echo "Deployment completed successfully!"